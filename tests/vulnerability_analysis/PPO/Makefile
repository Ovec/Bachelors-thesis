install:
	kubectl create namespace pgo
	kubectl config set-context $$(kubectl config current-context) --namespace=pgo
	kubectl apply -f ./install/install.yaml
	
create:
	kubectl apply -f ./create/high-availability/ha-postgres.yaml

test:
	trivy k8s --report summary cluster --timeout 3600s

testImages:
	trivy image percona/percona-postgresql-operator:1.4.0-pgo-apiserver --scanners vuln | grep Total
	trivy image percona/percona-postgresql-operator:1.4.0-pgo-event --scanners vuln | grep Total
	trivy image percona/percona-postgresql-operator:1.4.0-pgo-scheduler --scanners vuln | grep Total
	trivy image percona/percona-postgresql-operator:1.4.0-postgres-operator --scanners vuln | grep Total
	trivy image percona/percona-postgresql-operator:1.4.0-ppg14-pgbackrest-repo --scanners vuln | grep Total
	trivy image percona/percona-postgresql-operator:1.4.0-ppg14-postgres-ha --scanners vuln | grep Total
	trivy image percona/percona-postgresql-operator:1.4.0-ppg14-pgbouncer --scanners vuln | grep Total

remove:
	kubectl delete -f  ./create/high-availability/ha-postgres.yaml

uninstall:
	kubectl delete -f ./install/install.yaml
	kubectl delete ns pgo


.PHONY: install create test remove uninstall